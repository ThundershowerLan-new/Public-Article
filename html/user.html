<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title></title>
    <link rel="stylesheet" href="/static/css/public.css">
</head>
<body>
<header>
    <h1></h1>
    <nav>
        <a href="/">Public Article</a>
    </nav>
</header>
<hr>
<main>
</main>
<hr>
<footer>
    <small>Public Article by Thundershower</small>
</footer>
<dialog id="article">
    <form name="article" method="dialog">
        <label for="title">标题：</label>
        <input id="title" type="text" name="title" placeholder="请输入标题">
        <br><br>
        <label for="body"></label>
        <textarea id="body" name="body" style="width: 60vw; height: 60vh;"></textarea>
        <br><br>
        <button type="button" name="update">修改</button>
    </form>
</dialog>
<dialog id="login">
    <form name="verify" method="dialog">
        <label for="password">密码：</label>
        <input id="password" type="password" name="password" placeholder="请输入密码" required>
        <br><br>
        <button type="submit" onclick="login()">登录</button>
    </form>
</dialog>
<dialog id="error">
    <form name="error" method="dialog">
        <label>出现了一些错误。</label>
        <br><br>
        <button type="submit">确认</button>
    </form>
</dialog>
</body>

<script src="/static/js/cookies.min.js"></script>
<script src="/static/js/general_fetch.min.js"></script>
<script>
    const login_dialog = document.getElementById("login");
    const article_dialog = document.getElementById("article");
    const main = document.getElementsByTagName("main")[0];

    const id = Number(new URLSearchParams(document.location.search).get("id") || getCookie("id"));
    if (isNaN(id) || id < 0) {
        document.location.href = "/login";
    }

    const own = Number(getCookie("id")) === id;

    document.getElementsByTagName("nav")[0].innerHTML += own ? ` |\n<a href="/create">创作</a> |\n<a onclick="delete_user()" style="color: red">删除</a>` : ` |\n<a href="/user/${getCookie("id")}">${getCookie("name")}</a>`;

    general_fetch(`/user/${id}`, data => {
        document.title = data["name"];
        document.getElementsByTagName("h1")[0].innerText = data["name"];

        for (const index in data["articles"]) {
            main.innerHTML += `<a href="/article?id=${data["articles"][index]["id"]}">${data["articles"][index]["title"]}</a>${own ? ` <a onclick="delete_article(${data["articles"][index]["id"]})" style="color: red">删除</a> <a onclick="update_article(${data["articles"][index]["id"]})">更改</a>` : ""}<br><br>`
        }
    })

    function login() {
        general_fetch("/user", _ => {
            setCookie("id", getCookie("id"), 604800);
            setCookie("name", getCookie("name"), 604800);
            setCookie("logged", "true");

            create();
        }, "POST", JSON.stringify({
            name: getCookie("name"),
            password: document.verify.password.value
        }));
    }

    function delete_user() {
        if (!getCookie("logged")) {
            login_dialog.show();

            return
        }

        general_fetch(`/user/${id}`, _ => {
            deleteCookie("id");
            deleteCookie("name");
            deleteCookie("logged");

            document.location.href = "/";
        }, "DELETE");
    }

    function delete_article(article) {
        if (!getCookie("logged")) {
            login_dialog.show();

            return
        }

        general_fetch(
            `/article/${article}`,
            _ => document.location.reload(),
            "DELETE"
        )
    }

    function update_article(article) {
        general_fetch(`/article/${article}`, data => {
            document.article.title.value = data["title"];
            document.article.body.value = data["body"];
            document.article.update.setAttribute("onclick", `put_article(${article})`);

            article_dialog.show()
        })
    }

    function put_article(article) {
        if (!getCookie("logged")) {
            login_dialog.show();

            return
        }

        article_dialog.close()

        general_fetch(
            `/article/${article}`,
            _ => document.location.href = "/user",
            "PUT",
            JSON.stringify({
                title: document.article.title.value,
                body: document.article.body.value,
                creator: id
            })
        )
    }
</script>
</html>